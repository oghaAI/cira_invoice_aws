# Story 3.4: Results API Endpoint

## Status
Draft

## Story
As an API client,
I want `GET /jobs/{id}/result` endpoint,
so that I can retrieve extracted invoice data.

## Acceptance Criteria
1. Implement `GET /jobs/{id}/result` endpoint in API.
2. Return structured JSON with extracted data from `job_results.extracted_data`.
3. Include confidence score and metadata (e.g., model, tokens used if available).
4. Add basic cost information derived from token usage (see Story 3.5 pricing map).
5. Handle job not found and incomplete jobs with correct status codes.
6. Validate result shape before returning; ensure fields exist per schema when present.

## Tasks / Subtasks
- [ ] Task 1: API Gateway Route (AC: 1)
  - [ ] In `packages/infrastructure/src/stacks/api-stack.ts`, add resource `jobs/{jobId}/result` and method `GET` to `jobManagementFunction`

- [ ] Task 2: Handler Implementation (AC: 1, 2, 3, 5, 6)
  - [ ] In `packages/api/src/handlers/job-management.ts`:
    - [ ] Add branch for `resource === '/jobs/{jobId}/result'`
    - [ ] Validate `jobId`, check job ownership by API key when present
    - [ ] Fetch job; if not found → 404
    - [ ] If job status not `completed` → 409 (or 404 to avoid info leakage) with message `Job not completed`
    - [ ] Load `job_results` via `getJobResult(jobId)`
    - [ ] Validate `extracted_data` shape loosely against known keys (do not hard fail if extra keys present)
    - [ ] Build response including `{ job_id, extracted_data, confidence_score, tokens_used, cost? }`

- [ ] Task 3: Cost Info Hook (AC: 4)
  - [ ] Compute approximate cost using tokens used and model pricing from Story 3.5 helper (if available); otherwise omit field

- [ ] Task 4: Tests (AC: 2, 3, 5, 6)
  - [ ] Unit: 404 when job not found
  - [ ] Unit: 409 (or 404) when job incomplete
  - [ ] Unit: success returns JSON with data, confidence, tokens (and cost if available)
  - [ ] Unit: authorization by API key prevents access to other tenants

## Dev Notes
- Prefer 404 for both not-found and unauthorized to avoid information leakage; `409` is acceptable for same-tenant incomplete-state reporting.
- Do not enforce strict Zod validation in the read API; that is enforced during write in LLM step.
- Keep response minimal; do not include raw OCR.

## Testing
- Mock DB client to cover all branches; avoid external calls.

## File List
- packages/infrastructure/src/stacks/api-stack.ts
- packages/api/src/handlers/job-management.ts
- docs/stories/3.4.results-api-endpoint.md

## Change Log
- 2025-09-14: Drafted results endpoint story with validation and cost hook.

## QA Results

