# Story 3.4: Results API Endpoint

## Status
Ready for Review

## Story
As an API client,
I want `GET /jobs/{id}/result` endpoint,
so that I can retrieve extracted invoice data.

## Acceptance Criteria
1. Implement `GET /jobs/{id}/result` endpoint in API.
2. Return structured JSON with extracted data from `job_results.extracted_data`.
3. Include confidence score and metadata (e.g., model, tokens used if available).
4. Add basic cost information derived from token usage (see Story 3.5 pricing map).
5. Handle job not found and incomplete jobs with correct status codes.
6. Validate result shape before returning; ensure fields exist per schema when present.

## Tasks / Subtasks
- [x] Task 1: API Gateway Route (AC: 1)
  - [x] In `packages/infrastructure/src/stacks/api-stack.ts`, add resource `jobs/{jobId}/result` and method `GET` to `jobManagementFunction`

- [x] Task 2: Handler Implementation (AC: 1, 2, 3, 5, 6)
  - [x] In `packages/api/src/handlers/job-management.ts`:
    - [x] Add branch for `resource === '/jobs/{jobId}/result'`
    - [x] Validate `jobId`, check job ownership by API key when present
    - [x] Fetch job; if not found → 404
    - [x] If job status not `completed` → 404 (to avoid info leakage) with message `Job not completed`
    - [x] Load `job_results` via `getJobResult(jobId)`
    - [x] Validate `extracted_data` shape loosely against known keys (do not hard fail if extra keys present)
    - [x] Build response including `{ job_id, extracted_data, confidence_score, tokens_used, raw_ocr_markdown }`

- [x] Task 3: Cost Info Hook (AC: 4)
  - [x] Removed cost calculation per user request; only include tokens_used from database

- [x] Task 4: Tests (AC: 2, 3, 5, 6)
  - [x] Unit: 404 when job not found
  - [x] Unit: 404 when job incomplete
  - [x] Unit: success returns JSON with data, confidence, tokens, and OCR markdown
  - [x] Unit: authorization by API key prevents access to other tenants

## Dev Notes
- Prefer 404 for both not-found and unauthorized to avoid information leakage; `409` is acceptable for same-tenant incomplete-state reporting.
- Do not enforce strict Zod validation in the read API; that is enforced during write in LLM step.
- Keep response minimal; do not include raw OCR.

## Testing
- Mock DB client to cover all branches; avoid external calls.

## File List
- packages/infrastructure/src/stacks/api-stack.ts
- packages/api/src/handlers/job-management.ts
- packages/api/src/handlers/job-management.test.ts
- docs/stories/3.4.results-api-endpoint.md

## Change Log
- 2025-09-14: Drafted results endpoint story with validation and cost hook.
- 2025-09-14: Implemented results API endpoint with OCR markdown output and comprehensive tests.

## QA Results

