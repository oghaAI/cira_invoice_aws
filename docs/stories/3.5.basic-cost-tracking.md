# Story 3.5: Basic Cost Tracking

## Status
Draft

## Story
As a cost monitor,
I want simple token usage tracking,
so that I can understand processing costs.

## Acceptance Criteria
1. Track GPT-4 input and output tokens per job.
2. Store `tokens_used` in `job_results`.
3. Calculate approximate cost based on token usage and model pricing.
4. Add cost information to results endpoint response.
5. Emit basic cost logging without PII.
6. Provide a cost summary for completed jobs in logs/metrics.

## Tasks / Subtasks
- [ ] Task 1: Token Accounting (AC: 1, 2)
  - [ ] Capture token usage from AI SDK response (if available) in `callLlm()` / `extractStructured()`
  - [ ] Ensure `packages/api/src/handlers/llm-extraction.ts` persists tokens via `upsertJobResult`

- [ ] Task 2: Pricing Map (AC: 3)
  - [ ] Create `packages/api/src/services/llm/costs.ts` with `estimateCost({ model, inputTokens, outputTokens })`
  - [ ] Model pricing configurable by env (defaults reasonable); support `AZURE_OPENAI_DEPLOYMENT`
  - [ ] Return `{ currency: 'USD', total, breakdown: { input, output, unit: 'per 1K tokens' } }`

- [ ] Task 3: Result Endpoint Hook (AC: 4)
  - [ ] Update `GET /jobs/{id}/result` to include `cost` if tokens present

- [ ] Task 4: Logging & Metrics (AC: 5, 6)
  - [ ] Emit structured logs `{ jobId, model, tokensUsed, estimatedCost }`; no content
  - [ ] Expose basic CloudWatch metrics (counter: invocations, sum: tokens, sum: estimated_cost_usd)

- [ ] Task 5: Tests (AC: 3, 4)
  - [ ] Unit: cost estimation against known pricing
  - [ ] Unit: endpoint includes cost field when tokens exist; omitted otherwise

## Dev Notes
- Pricing accuracy is best-effort and advisory; source of truth is provider billing.
- Keep pricing configurable to adapt per environment and Azure region deployments.

## Testing
- Mock AI SDK to return token counts; verify persistence and endpoint shape.
- Verify pricing math and rounding rules.

## File List
- packages/api/src/services/llm/costs.ts
- packages/api/src/services/llm/client.ts
- packages/api/src/handlers/llm-extraction.ts
- packages/api/src/handlers/job-management.ts
- docs/stories/3.5.basic-cost-tracking.md

## Change Log
- 2025-09-14: Drafted cost tracking story with pricing map and endpoint integration.

## QA Results

