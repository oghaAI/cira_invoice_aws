# Story 3.2: Simple Invoice Schema with Zod

## Status
Draft

## Story
As a data extractor,
I want basic invoice field extraction defined with Zod,
so that I can return validated structured invoice data.

## Acceptance Criteria
1. Adopt the provided modifiable Zod schema shape (all fields optional and nullable as specified):
   - Strings: `invoice_date`, `invoice_number`, `invoice_due_date`, `policy_number`, `account_number`, `policy_start_date`, `policy_end_date`, `service_start_date`, `service_end_date`, `payment_remittance_address`, `payment_remittance_entity`, `payment_remittance_entity_care_of`, `reasoning`, `community_name`, `vendor_name` (all `z.string().nullable().optional()`).
   - Numbers: `invoice_past_due_amount`, `invoice_current_due_amount`, `invoice_late_fee_amount`, `credit_amount` (all `z.number().nullable().optional()`).
   - Boolean: `valid_input: z.boolean().optional()`.
   - Keep field `.describe()` texts to guide the model (synonyms and extraction guidance included).
2. Include a parallel `field_reasoning` map in the schema: `z.record(z.string())` (optional) containing concise reasoning for every field, including when a field is null (e.g., "not present", "ambiguous", "unreadable"); avoid long snippets or PII beyond labels.
3. Include a parallel `field_confidence` map in the schema: `z.record(z.enum(['low','medium','high']))` (optional), with entries for every field. For null fields, confidence typically should be `low` (or `medium` if evidence suggests ambiguity rather than absence).
4. Create TypeScript types with `z.infer<typeof InvoiceSchema>` and export both the schema and type from `packages/api/src/services/llm/schemas/invoice.ts`.
5. Implement structured output using the AI SDK with Zod validation; the model must return only fields in the schema. Unknown keys are ignored.
6. Validate model output against the schema; do not invent values. Strings may be trimmed; numbers may accept numeric-like strings via a safe preprocessor (optional) but must store as numbers or null.
7. Persist extracted data to `job_results.extracted_data` (JSONB), including `field_reasoning` and `field_confidence`. Tolerate missing fields by storing nulls or omitting.
8. The schema must be easily modifiable: adding/removing fields should not break consumers. Provide guidance/comments for evolution.

## Tasks / Subtasks
- [ ] Task 1: Implement Provided Schema (AC: 1, 2, 3, 8)
  - [ ] Create `packages/api/src/services/llm/schemas/invoice.ts` exporting `InvoiceSchema` exactly matching the provided fields, all `nullable().optional()` as described.
  - [ ] Add `field_reasoning?: Record<string,string>` to the schema; keep reasoning concise (≤ 2 sentences), no long snippets.
  - [ ] Add `field_confidence?: Record<string, 'low'|'medium'|'high'>` to the schema; include entries for all fields (including nulls) per prompt guidance.
  - [ ] Keep `.describe()` texts to guide the LLM (include synonyms and extraction constraints for service dates).
  - [ ] Export `export type Invoice = z.infer<typeof InvoiceSchema>`.
  - [ ] Add a comment header: “Schema is evolvable; add new optional/nullable fields to avoid breaking changes.”

- [ ] Task 2: Structured Output with AI SDK (AC: 4, 5, 6)
  - [ ] In `packages/api/src/services/llm/client.ts`, add a helper `extractStructured<T>()` that accepts a Zod schema and prompt input, returning `Promise<{ data: T; tokensUsed?: number; confidence?: number }>`
  - [ ] Use AI SDK structured output mode with Zod validator; throw `VALIDATION` error on schema failure
  - [ ] Include minimal normalization (e.g., trim strings); optional preprocessor can convert numeric-like strings to numbers safely, else null
  - [ ] Prompt guidance: “Return only fields in the schema, plus `field_reasoning` (1–2 sentences for every field, including when null) and `field_confidence` (one of: low, medium, high) for every field. For null fields, explain why and set confidence accordingly. Do not return decimals.”

- [ ] Task 3: Handler Integration (AC: 5, 6, 7)
  - [ ] Update `packages/api/src/handlers/llm-extraction.ts` to:
    - [ ] Load OCR text from prior step input
    - [ ] Call `extractStructured(InvoiceSchema, { markdown })`
    - [ ] Receive `{ data, tokensUsed, confidence }`
    - [ ] Persist via `DatabaseClient.upsertJobResult({ jobId, extractedData: data, tokensUsed })`
    - [ ] Return object for Step Functions: `{ jobId, status: 'llm_completed', extractedData: data, tokensUsed: tokensUsed ?? null }`

- [ ] Task 4: Tests (AC: 2, 3, 5, 7)
  - [ ] Unit: accepts null/undefined for optional fields; rejects wrong types (e.g., non-numeric strings for numeric fields unless preprocessed)
  - [ ] Unit: successful extraction returns typed data matching `Invoice`
  - [ ] Unit: handler persists JSONB (including `field_reasoning` and `field_confidence`) and tokens; verify upsert payload
  - [ ] Unit: `field_reasoning` provides entries (short strings) explaining both populated and null fields
  - [ ] Unit: `field_confidence` contains only low/medium/high; includes entries for null fields (typically `low`)
  - [ ] Unit: unknown keys from the model are ignored/stripped

## Dev Notes
- Keep all fields optional+nullable to reflect real-world variance; the orchestrator must not fail just because a field is absent.
- Confidence is intentionally out-of-scope for this story; can be added later as categorical (L/M/H) and mapped server-side.
- Dates: accept strings; avoid silent reformatting. If normalizing, do it in a separate mapping function, not the schema.
- Modifiability: when adding new fields, default them to `nullable().optional()`. Consumers should read defensively.

## Testing
- Mock AI SDK to return valid/invalid shapes; assert Zod validation outcomes.
- Verify DB persistence path by mocking `DatabaseClient` in handler unit tests.

## File List
- packages/api/src/services/llm/schemas/invoice.ts
- packages/api/src/services/llm/client.ts
- packages/api/src/handlers/llm-extraction.ts
- docs/stories/3.2.invoice-schema-zod.md

## Change Log
- 2025-09-14: Drafted Zod schema story and handler integration.

## QA Results
