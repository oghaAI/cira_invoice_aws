# Story 3.3: Data Extraction Processing in Step Functions

## Status
Done

## Story
As a processing pipeline,
I want LLM extraction in Step Functions,
so that OCR text becomes validated structured data persisted in the DB.

## Acceptance Criteria
1. Add/confirm LLM processing state in Step Functions after OCR state.
2. Implement LLM extraction Lambda that consumes OCR text and returns structured data.
3. Parse structured output and validate against Zod schema.
4. Validate extraction result (required fields present) and handle failures.
5. Store final results in `job_results` (JSONB + confidence + tokens).
6. Update job status to "completed" upon success.
7. Track token usage and include in metadata for cost reporting.

## Tasks / Subtasks
- [x] Task 1: Step Functions Wiring (AC: 1)
  - [x] Verify `packages/infrastructure/src/stacks/workflow-stack.ts` contains `LlmExtractionStep` after OCR step
  - [x] Ensure retries and catches are configured similarly to OCR step
  - [x] Confirm phase transitions: `extracting_data` -> `verifying_data` -> `complete`

- [x] Task 2: Lambda Handler Implementation (AC: 2, 3, 4, 5, 7)
  - [x] Update `packages/api/src/handlers/llm-extraction.ts` to:
    - [x] Validate input contains `{ jobId, ocr: { metadata } }` - reads markdown from database
    - [x] Invoke AI SDK client with `InvoiceExtractionSchema` (from Story 3.2)
    - [x] On success: persist result with `DatabaseClient.upsertJobResult`
    - [x] Return `{ jobId, status: 'llm_completed', result: { extractedData, confidence, tokensUsed }, metadata }`
    - [x] On failure: throw typed error for Step Functions catch

- [x] Task 3: Job Completion Step (AC: 6)
  - [x] Ensure `packages/api/src/handlers/job-management.ts` handles action `complete` to set job `completed` and clear phase (exists); verify it stores result fields provided by LLM step

- [x] Task 4: Tests (AC: 2, 3, 4, 5, 7)
  - [x] Unit: handler refuses when OCR metadata missing
  - [x] Unit: valid extraction persists JSONB + confidence + tokens
  - [x] Unit: validation errors propagate as typed errors for Step Functions
  - [x] Unit: transient errors cause retry-eligible error types

## Dev Notes
- Minimize payload sizes between steps; pass only necessary fields.
- Consistent logging across steps enables end-to-end tracing by `jobId`.
- Do not log OCR content; only lengths/metadata.

## Testing
- Simulate Step Functions event shapes to the Lambda; assert outputs.
- Mock DB client and AI SDK to isolate path coverage.

## File List
- packages/infrastructure/src/stacks/workflow-stack.ts
- packages/api/src/handlers/llm-extraction.ts
- packages/api/src/handlers/llm-extraction.test.ts
- packages/api/src/handlers/job-management.ts
- packages/api/src/services/llm/client.ts
- packages/api/src/services/llm/schemas/invoice.ts
- docs/stories/3.3.llm-extraction-processing.md

## Change Log
- 2025-09-14: Drafted processing integration story aligned to existing workflow stack.
- 2025-09-14: Implemented LLM extraction processing with Step Functions integration.

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- Updated LLM extraction handler to accept Step Functions input format
- Handler now reads OCR text from database instead of Step Functions payload
- Added proper error handling with typed errors for Step Functions
- Updated tests to match new input/output format
- All 12 test cases passing

### Completion Notes
- ✅ Step Functions workflow already properly configured for LLM extraction step
- ✅ LLM extraction handler updated to process Step Functions events
- ✅ Input validation for jobId and OCR metadata presence
- ✅ AI SDK integration with InvoiceExtractionSchema from Story 3.2
- ✅ Database persistence with confidence score and token usage tracking
- ✅ Proper error handling with typed errors for Step Functions catch blocks
- ✅ Job completion handler verified to handle result storage
- ✅ Comprehensive test suite with 12 test cases covering all requirements
- ✅ Phase transitions properly implemented: extracting_data -> verifying_data -> complete

### Status
Ready for Review

## QA Results

### Review Date: 2025-09-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation that demonstrates enterprise-grade patterns with comprehensive error handling, structured logging, and robust test coverage. The code follows established patterns from the OCR handler while adding proper LLM integration. Database operations are properly managed with try/finally blocks, and Step Functions integration is clean with proper result path handling.

### Refactoring Performed

None required - the code quality is already high and follows established project patterns consistently.

### Compliance Check

- Coding Standards: ✓ Uses structured console logging, proper error handling, TypeScript 5.6.2, Node.js 20.17.0
- Project Structure: ✓ Co-located test files, follows established handler patterns
- Testing Strategy: ✓ Comprehensive test coverage with 12 test cases covering all acceptance criteria
- All ACs Met: ✓ All 7 acceptance criteria fully implemented and tested

### Improvements Checklist

All improvements already implemented in the current code:

- [x] Comprehensive error handling with typed errors for Step Functions
- [x] Proper database connection management with try/finally blocks
- [x] Structured logging with JSON format following project standards
- [x] Full test coverage including edge cases and error scenarios
- [x] Clean separation of concerns between validation, processing, and persistence
- [x] Consistent patterns with existing OCR handler implementation
- [ ] Consider extracting database configuration to shared utility (minor enhancement)
- [ ] Consider adding performance monitoring for LLM extraction duration (future)

### Security Review

✓ **PASS** - No security concerns identified:
- No sensitive data logged (follows dev notes: "Do not log OCR content")
- Proper input validation prevents injection attacks
- Database credentials handled securely via environment variables
- Error messages don't expose internal system details
- Uses parameterized queries through DatabaseClient abstraction

### Performance Considerations

✓ **PASS** - Performance is well-considered:
- Proper timeout configuration (15 minutes for LLM processing)
- Efficient database connection management with proper cleanup
- Minimal payload sizes between Step Functions steps
- Token usage tracking for cost monitoring
- Processing time metrics included in metadata

### Requirements Traceability

All acceptance criteria mapped to test coverage:

**AC 1**: Step Functions wiring → Verified in workflow-stack.ts (lines 92-98, 192-195)
**AC 2**: LLM extraction handler → Implemented and tested (12 test scenarios)
**AC 3**: Zod schema parsing → Uses InvoiceSchema from Story 3.2, tested
**AC 4**: Validation handling → Tested with missing data scenarios
**AC 5**: Database persistence → Tested with JSONB, confidence, token storage
**AC 6**: Job completion → Verified job-management.ts handles 'complete' action
**AC 7**: Token tracking → Implemented and tested in all scenarios

### Files Modified During Review

None - no modifications were necessary.

### Gate Status

Gate: PASS → docs/qa/gates/3.3-llm-extraction-processing.yml

### Recommended Status

✓ Ready for Done - All requirements met with excellent code quality and comprehensive test coverage.

