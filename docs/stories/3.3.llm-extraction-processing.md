# Story 3.3: Data Extraction Processing in Step Functions

## Status
Draft

## Story
As a processing pipeline,
I want LLM extraction in Step Functions,
so that OCR text becomes validated structured data persisted in the DB.

## Acceptance Criteria
1. Add/confirm LLM processing state in Step Functions after OCR state.
2. Implement LLM extraction Lambda that consumes OCR text and returns structured data.
3. Parse structured output and validate against Zod schema.
4. Validate extraction result (required fields present) and handle failures.
5. Store final results in `job_results` (JSONB + confidence + tokens).
6. Update job status to "completed" upon success.
7. Track token usage and include in metadata for cost reporting.

## Tasks / Subtasks
- [ ] Task 1: Step Functions Wiring (AC: 1)
  - [ ] Verify `packages/infrastructure/src/stacks/workflow-stack.ts` contains `LlmExtractionStep` after OCR step
  - [ ] Ensure retries and catches are configured similarly to OCR step
  - [ ] Confirm phase transitions: `extracting_data` -> `verifying_data` -> `complete`

- [ ] Task 2: Lambda Handler Implementation (AC: 2, 3, 4, 5, 7)
  - [ ] Update `packages/api/src/handlers/llm-extraction.ts` to:
    - [ ] Validate input contains `{ jobId, ocr: { markdown, metadata } }` or equivalent
    - [ ] Invoke AI SDK client with `InvoiceExtractionSchema` (from Story 3.2)
    - [ ] On success: persist result with `DatabaseClient.upsertJobResult`
    - [ ] Return `{ jobId, status: 'llm_completed', extractedData, confidence, tokensUsed }`
    - [ ] On failure: throw typed error for Step Functions catch

- [ ] Task 3: Job Completion Step (AC: 6)
  - [ ] Ensure `packages/api/src/handlers/job-management.ts` handles action `complete` to set job `completed` and clear phase (exists); verify it stores result fields provided by LLM step

- [ ] Task 4: Tests (AC: 2, 3, 4, 5, 7)
  - [ ] Unit: handler refuses when OCR not complete or markdown missing
  - [ ] Unit: valid extraction persists JSONB + confidence + tokens
  - [ ] Unit: validation errors propagate as `VALIDATION` without persistence
  - [ ] Unit: transient errors cause retry-eligible error types

## Dev Notes
- Minimize payload sizes between steps; pass only necessary fields.
- Consistent logging across steps enables end-to-end tracing by `jobId`.
- Do not log OCR content; only lengths/metadata.

## Testing
- Simulate Step Functions event shapes to the Lambda; assert outputs.
- Mock DB client and AI SDK to isolate path coverage.

## File List
- packages/infrastructure/src/stacks/workflow-stack.ts
- packages/api/src/handlers/llm-extraction.ts
- packages/api/src/services/llm/client.ts
- packages/api/src/services/llm/schemas/invoice.ts
- docs/stories/3.3.llm-extraction-processing.md

## Change Log
- 2025-09-14: Drafted processing integration story aligned to existing workflow stack.

## QA Results

