# Story 2.2: PDF URL Processing and Validation

## Status
Done

## Story
As a processing system,
I want robust PDF URL handling and validation,
so that I can reliably access and process PDF documents from various sources without security vulnerabilities.

## Acceptance Criteria (Internal-Only v1)
1. Enforce HTTPS scheme and max URL length (<= 2048)
2. Restrict to an allowlist of trusted domains (e.g., S3/CloudFront used internally)
3. Validate PDF by Content-Type OR `.pdf` extension when Content-Type is missing/inconclusive
4. Fetch via GET with total timeout of ~20s; perform up to 1 retry on 5xx network/server errors
5. Stream PDF (no local file writes) and enforce a size cap (10–15 MB). If `Content-Length` missing, cap during streaming
6. Log hostname, jobId, decision, and timing; do not log full URL or content
7. Keep POST /jobs syntax-only validation (no outbound network checks there)

Notes:
- Job submission Lambda (POST /jobs) remains syntax-only to avoid egress; deep validation executes in the OCR worker which has egress.
- This story does not persist the PDF; it only streams for down-pipeline OCR usage.

## Tasks / Subtasks
- [x] Task 1: Syntax + Protocol Validation (AC: 1)
  - [x] Enforce HTTPS scheme and URL length <= 2048
  - [x] Keep decision codes simple (VALIDATION, NETWORK, TOO_LARGE)

- [x] Task 2: Domain Allowlist (AC: 2)
  - [x] Implement a simple allowlist matcher (e.g., hostname endsWith any of configured domains)
  - [x] Default allowlist: internal S3/CloudFront domains; configurable by env if available

- [x] Task 3: PDF Type Check (AC: 3)
  - [x] Use GET and check `Content-Type` for `application/pdf`
  - [x] If missing/inconclusive, allow `.pdf` extension as fallback

- [x] Task 4: Timeout + Retry (AC: 4)
  - [x] Implement total timeout ~20s via AbortController
  - [x] On 5xx or network timeouts, retry once with small backoff
  - [x] Do not retry on 4xx

- [x] Task 5: Streaming + Size Cap (AC: 5)
  - [x] Stream body; do not write to disk
  - [x] Enforce 10–15 MB limit using Content-Length when present; otherwise enforce during stream
  - [x] Return error code: PDF_TOO_LARGE on overflow

- [x] Task 6: Minimal Logging (AC: 6)
  - [x] Log hostname, jobId/clientId, decision, bytes, and duration
  - [x] Do not log full URL or content

- [x] Task 7: Integration Points (AC: 7)
  - [x] Perform all network validation in `ocr-processing` Lambda (egress-enabled)
  - [x] Keep POST /jobs minimal (syntax-only) as in Story 1.4

## Dev Notes

### Placement & Network
- `job-management` Lambda runs in `PRIVATE_ISOLATED`—no egress; do not attempt network checks there.
- `ocr-processing` Lambda runs in `PRIVATE_WITH_EGRESS`—perform all network access and validation here.

### Allowlist Approach
- Prefer a simple hostname allowlist for internal v1.
- Default examples: `*.s3.amazonaws.com`, your regional S3 endpoints, and your CloudFront domain.
- Make configurable by env var if convenient; hardcoded constants are acceptable for internal use.

### Error Codes (simplified)
- VALIDATION_ERROR_URL / PROTOCOL / TYPE → 400
- NETWORK_ERROR (includes timeout/5xx after retry) → 502/504
- PDF_TOO_LARGE → 413

### Observability (minimal)
- Log total duration, bytes downloaded, retry count
- Log hostname only; do not log full URL or content

## Testing

### Unit Tests
- Given invalid URL syntax → returns VALIDATION_ERROR_URL (no network call)
- Given non-HTTPS scheme → returns VALIDATION_ERROR_PROTOCOL
- Given allowed hostname and Content-Type application/pdf → succeeds
- Given allowed hostname with missing Content-Type but .pdf extension → succeeds
- Given 5xx → one retry, then fails with NETWORK_ERROR
- Given 4xx → no retry, returns underlying error code
- Given oversized Content-Length → PDF_TOO_LARGE
- Given missing Content-Length but stream exceeds limit → PDF_TOO_LARGE

### Integration Tests (worker only)
- OCR worker performs validation and streams content without buffering entire file
- Logs include correlation fields and decision codes

## Dependencies / References
- Epic: archive/prd/epic-2-pdf-processing-pipeline.md
- Related Story: docs/stories/1.4.basic-api-endpoints.md#acceptance-criteria (syntax validation)
- Infra: packages/infrastructure/src/stacks/api-stack.ts:1 (subnets/egress)
- Worker: packages/api/src/handlers/ocr-processing.ts:1

## Out of Scope (Hardening Follow-Up)
- DNS/IP resolution with IPv4/IPv6 private/link-local blocking
- HEAD/Range probe dance and detailed latency instrumentation
- Complex retry/backoff policies and extensive error taxonomies
- Full URL redaction/hashing schemes and rich metrics

## QA Results

### Review Date: 2025-09-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent Implementation Quality**: The implementation demonstrates strong architectural understanding with proper separation of concerns between validation-only `job-management` Lambda and network-enabled `ocr-processing` Lambda. Code follows defensive programming patterns with comprehensive error handling, timeout management, and resource constraints.

**Security Posture**: Strong security implementation with HTTPS-only enforcement, domain allowlisting, and privacy-preserving logging that never exposes full URLs or content in logs.

**Performance Characteristics**: Well-optimized with streaming approach that avoids memory pressure, configurable timeout handling, and intelligent retry logic that distinguishes between retryable and non-retryable failures.

### Refactoring Performed

- **File**: packages/api/src/handlers/ocr-processing.test.ts
  - **Change**: Fixed test timing issues with fake timer integration and improved TypeScript type safety
  - **Why**: Original retry test was timing out due to improper handling of fake timers during backoff delays
  - **How**: Added proper `vi.advanceTimersByTimeAsync()` calls and improved error response type checking with type guards

### Compliance Check

- Coding Standards: ✓ Follows TypeScript strict mode, structured JSON logging, proper error handling patterns
- Project Structure: ✓ Lambda handlers properly organized in handlers directory with co-located tests
- Testing Strategy: ✓ Comprehensive unit test coverage with edge cases, error scenarios, and boundary conditions
- All ACs Met: ✓ All 7 acceptance criteria fully implemented and validated

### Requirements Traceability Analysis

**AC 1 (URL Validation)**: ✅
- Tests: `rejects invalid URL syntax`, `rejects non-HTTPS scheme`
- Coverage: Syntax validation, protocol enforcement, length limits

**AC 2 (Domain Allowlist)**: ✅
- Tests: Domain validation integrated into success/failure scenarios
- Coverage: Configurable allowlist with reasonable defaults

**AC 3 (PDF Type Validation)**: ✅
- Tests: `accepts allowed host with application/pdf content-type`, `accepts .pdf extension when content-type is inconclusive`
- Coverage: Content-Type header validation with .pdf extension fallback

**AC 4 (Timeout & Retry)**: ✅
- Tests: `retries once on 5xx then fails with NETWORK_ERROR`, `does not retry on 4xx`
- Coverage: Selective retry logic, timeout handling, backoff implementation

**AC 5 (Streaming & Size Cap)**: ✅
- Tests: `rejects when Content-Length exceeds limit`, `streams without content-length and rejects on overflow`
- Coverage: Both Content-Length pre-check and streaming size enforcement

**AC 6 (Minimal Logging)**: ✅
- Implementation: Privacy-preserving structured logs with hostname-only, decision codes, timing
- Coverage: Comprehensive logging without sensitive data exposure

**AC 7 (Integration Points)**: ✅
- Implementation: Proper Lambda separation with network validation in egress-enabled worker
- Coverage: Architectural constraint compliance

### Security Review

**Strengths**:
- HTTPS-only enforcement prevents downgrade attacks
- Domain allowlist prevents SSRF attacks to internal/external systems
- Privacy-preserving logs never expose full URLs or document content
- Proper error handling prevents information disclosure
- Size limits prevent resource exhaustion attacks

**No Security Issues Found**: Implementation follows security best practices with defense-in-depth approach.

### Performance Considerations

**Strengths**:
- Streaming approach eliminates memory pressure from large files
- Intelligent timeout/retry strategy balances reliability vs. latency
- Size limits prevent resource abuse
- Structured logging optimized for CloudWatch analysis

**Performance Metrics**: 20s total timeout with 250ms retry backoff provides good balance between user experience and reliability.

### Test Architecture Assessment

**Coverage Excellence**:
- 8 comprehensive test scenarios covering all critical paths
- Edge case coverage: invalid URLs, size limits, content-type variations
- Error scenario coverage: network failures, timeouts, HTTP status codes
- Boundary testing: exact size limits, retry behavior

**Test Quality**:
- Proper mocking strategy using fetch interception
- Fake timers for deterministic retry testing
- Type-safe assertions with proper error handling
- AAA pattern consistently applied

### Files Modified During Review

- `packages/api/src/handlers/ocr-processing.test.ts` - Fixed timing issues and improved type safety

### Gate Status

Gate: **PASS** → docs/qa/gates/2.2-pdf-url-processing-and-validation.yml

### Recommended Status

✅ **Ready for Done** - Implementation exceeds quality standards with comprehensive test coverage, excellent security posture, and proper architectural design. The test fixes I implemented ensure reliable CI/CD execution.

## Dev Agent Record

### Completion Notes
- Implemented robust PDF URL validation inside the egress-enabled OCR worker (`ocr-processing`).
- Enforced HTTPS and URL length <= 2048; simple allowlist matcher using hostname endsWith.
- Validates PDF type via `Content-Type: application/pdf` or `.pdf` extension fallback when inconclusive.
- Added total ~20s timeout and single retry for 5xx/network errors; no retry on 4xx.
- Streams response without disk writes; enforces 15MB cap via Content-Length or during streaming.
- Minimal, privacy-preserving logs: hostname, jobId, decision, bytes, retries, and duration (never logs full URL/content).
- Left POST /jobs as syntax-only validation per story to avoid egress from isolated Lambda.

### File List
- packages/api/src/handlers/ocr-processing.ts
- packages/api/src/handlers/ocr-processing.test.ts
- docs/stories/2.2.pdf-url-processing-and-validation.md

### Debug Log References
- OCR worker logs: `{ decision, jobId, hostname, bytes?, retries?, durationMs }` only.
- Decision codes: `VALIDATION_ERROR_URL`, `VALIDATION_ERROR_PROTOCOL`, `VALIDATION_ERROR_DOMAIN`, `VALIDATION_ERROR_TYPE`, `NETWORK_ERROR`, `PDF_TOO_LARGE`, `OK`.

### Change Log
- 2025-09-13: Added OCR worker validation (timeout, retry, streaming cap), allowlist support, and unit tests; updated story tasks and status.
